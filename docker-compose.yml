version: '3.8'

services:
  # MCP Web Search Server
  mcp-web-search:
    build:
      context: .
      dockerfile: docker/Dockerfile.mcp
    container_name: a2a-mcp-web-search
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=production
      - PORT=3100
      - HOST=0.0.0.0
      - LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3100/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - a2a-network

  # Research Agent
  research-agent:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: a2a-research-agent
    command: ["node", "packages/research-agent/dist/server.js"]
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
      - LOG_LEVEL=info
      - VERTEX_AI_PROJECT=${VERTEX_AI_PROJECT}
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us-central1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-pro}
      - GEMINI_TEMPERATURE=${GEMINI_TEMPERATURE:-0.7}
      - GEMINI_MAX_OUTPUT_TOKENS=${GEMINI_MAX_OUTPUT_TOKENS:-8192}
      - MCP_WEB_SEARCH_URL=http://mcp-web-search:3100/mcp
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/gcp-key.json
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS_PATH:-./credentials}:/app/credentials:ro
    depends_on:
      mcp-web-search:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - a2a-network

  # Analysis Agent
  analysis-agent:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: a2a-analysis-agent
    command: ["node", "packages/analysis-agent/dist/server.js"]
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - HOST=0.0.0.0
      - LOG_LEVEL=info
      - VERTEX_AI_PROJECT=${VERTEX_AI_PROJECT}
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us-central1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-pro}
      - GEMINI_TEMPERATURE=${GEMINI_TEMPERATURE:-0.7}
      - GEMINI_MAX_OUTPUT_TOKENS=${GEMINI_MAX_OUTPUT_TOKENS:-8192}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/gcp-key.json
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS_PATH:-./credentials}:/app/credentials:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - a2a-network

  # Writer Agent
  writer-agent:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: a2a-writer-agent
    command: ["node", "packages/writer-agent/dist/server.js"]
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - HOST=0.0.0.0
      - LOG_LEVEL=info
      - VERTEX_AI_PROJECT=${VERTEX_AI_PROJECT}
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us-central1}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-pro}
      - GEMINI_TEMPERATURE=${GEMINI_TEMPERATURE:-0.7}
      - GEMINI_MAX_OUTPUT_TOKENS=${GEMINI_MAX_OUTPUT_TOKENS:-8192}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/gcp-key.json
    volumes:
      - ${GOOGLE_APPLICATION_CREDENTIALS_PATH:-./credentials}:/app/credentials:ro
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - a2a-network

  # Orchestrator
  orchestrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.orchestrator
    container_name: a2a-orchestrator
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      - LOG_LEVEL=info
      - RESEARCH_AGENT_URL=http://research-agent:3001
      - ANALYSIS_AGENT_URL=http://analysis-agent:3002
      - WRITER_AGENT_URL=http://writer-agent:3003
      - AGENT_TIMEOUT=30000
    depends_on:
      research-agent:
        condition: service_healthy
      analysis-agent:
        condition: service_healthy
      writer-agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - a2a-network

networks:
  a2a-network:
    driver: bridge
